name: Process Parking Updates

on:
  # Run every 5 minutes
  schedule:
    - cron: '*/5 * * * *'
  
  # Can also be triggered manually
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all data'
        required: false
        default: 'false'

jobs:
  process-updates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install axios
        
    - name: Process parking updates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        node << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        console.log('ðŸš— Memulai proses update data parkir Ops Ketupat 2026...');
        
        // Path files
        const dataPath = path.join(__dirname, 'data/parkir-data.json');
        const updatesPath = path.join(__dirname, 'data/updates/pending-updates.json');
        const archiveDir = path.join(__dirname, 'data/updates/archive');
        
        // Buat folder archive jika belum ada
        if (!fs.existsSync(archiveDir)) {
          fs.mkdirSync(archiveDir, { recursive: true });
        }
        
        // Baca data utama
        let mainData = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
        
        // Baca pending updates
        let updates = [];
        if (fs.existsSync(updatesPath)) {
          updates = JSON.parse(fs.readFileSync(updatesPath, 'utf8'));
        }
        
        console.log(`ðŸ“Š Ditemukan ${updates.length} update yang menunggu`);
        
        // Proses setiap update
        const processedUpdates = [];
        const failedUpdates = [];
        
        for (const update of updates) {
          try {
            // Validasi update
            if (!update.location_id || !update.petugas_name) {
              throw new Error('Data update tidak valid');
            }
            
            // Cari lokasi
            const locationIndex = mainData.locations.findIndex(
              loc => loc.id === update.location_id
            );
            
            if (locationIndex === -1) {
              throw new Error(`Lokasi ${update.location_id} tidak ditemukan`);
            }
            
            // Update kapasitas
            const location = mainData.locations[locationIndex];
            
            if (update.bus !== undefined) {
              location.bus.available = update.bus;
              location.bus.last_update = new Date().toISOString();
              location.bus.updated_by = update.petugas_name;
            }
            
            if (update.mobil !== undefined) {
              location.mobil.available = update.mobil;
              location.mobil.last_update = new Date().toISOString();
              location.mobil.updated_by = update.petugas_name;
            }
            
            if (update.motor !== undefined) {
              location.motor.available = update.motor;
              location.motor.last_update = new Date().toISOString();
              location.motor.updated_by = update.petugas_name;
            }
            
            if (update.notes) {
              location.notes = update.notes;
            }
            
            // Update status jika perlu
            const totalCapacity = (location.bus.total || 0) + 
                                 (location.mobil.total || 0) + 
                                 (location.motor.total || 0);
            const availableCapacity = (location.bus.available || 0) + 
                                     (location.mobil.available || 0) + 
                                     (location.motor.available || 0);
            
            if (availableCapacity === 0 && totalCapacity > 0) {
              location.status = 'full';
            } else if (availableCapacity / totalCapacity < 0.1) {
              location.status = 'almost_full';
            } else {
              location.status = 'open';
            }
            
            update.processed_at = new Date().toISOString();
            update.status = 'processed';
            processedUpdates.push(update);
            
            console.log(`âœ… Updated: ${location.nama} (Petugas: ${update.petugas_name})`);
            
          } catch (error) {
            console.error(`âŒ Gagal memproses update:`, error.message);
            update.error = error.message;
            update.status = 'failed';
            failedUpdates.push(update);
          }
        }
        
        // Update statistics
        let totalAvailableBus = 0;
        let totalAvailableMobil = 0;
        let totalAvailableMotor = 0;
        
        mainData.locations.forEach(location => {
          totalAvailableBus += location.bus.available || 0;
          totalAvailableMobil += location.mobil.available || 0;
          totalAvailableMotor += location.motor.available || 0;
        });
        
        mainData.statistics = {
          ...mainData.statistics,
          total_available_bus: totalAvailableBus,
          total_available_mobil: totalAvailableMobil,
          total_available_motor: totalAvailableMotor,
          update_count_today: (mainData.statistics.update_count_today || 0) + processedUpdates.length,
          last_processed: new Date().toISOString()
        };
        
        mainData.metadata.last_updated = new Date().toISOString();
        mainData.metadata.updated_by = 'GitHub Actions';
        
        // Simpan data utama
        fs.writeFileSync(dataPath, JSON.stringify(mainData, null, 2));
        
        // Archive processed updates
        const today = new Date().toISOString().split('T')[0];
        const archiveFile = path.join(archiveDir, `updates-${today}.json`);
        
        let archiveData = [];
        if (fs.existsSync(archiveFile)) {
          archiveData = JSON.parse(fs.readFileSync(archiveFile, 'utf8'));
        }
        
        archiveData.push(...processedUpdates);
        fs.writeFileSync(archiveFile, JSON.stringify(archiveData, null, 2));
        
        // Reset pending updates (simpan yang failed)
        fs.writeFileSync(updatesPath, JSON.stringify(failedUpdates, null, 2));
        
        console.log('\nðŸŽ‰ PROSES SELESAI');
        console.log(`âœ… Berhasil diproses: ${processedUpdates.length}`);
        console.log(`âŒ Gagal diproses: ${failedUpdates.length}`);
        console.log(`ðŸšŒ Total bus tersedia: ${totalAvailableBus}`);
        console.log(`ðŸš— Total mobil tersedia: ${totalAvailableMobil}`);
        console.log(`ðŸï¸ Total motor tersedia: ${totalAvailableMotor}`);
        console.log(`ðŸ• Waktu: ${new Date().toLocaleTimeString('id-ID')}`);
        
        // Commit dan push perubahan
        const execSync = require('child_process').execSync;
        
        execSync('git config --global user.email "actions@github.com"');
        execSync('git config --global user.name "GitHub Actions"');
        
        execSync('git add .');
        execSync('git commit -m "ðŸ”„ Update data parkir Ops Ketupat 2026 [auto]" || echo "No changes to commit"');
        execSync('git push');
        
        EOF
        
    - name: Create summary
      if: always()
      run: |
        echo "## Update Data Parkir Ops Ketupat 2026" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Waktu Proses:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Sistem berjalan setiap 5 menit untuk memproses update dari petugas." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— Aplikasi publik: https://YOUR_USERNAME.github.io/ops-ketupat-progo-2026/" >> $GITHUB_STEP_SUMMARY
