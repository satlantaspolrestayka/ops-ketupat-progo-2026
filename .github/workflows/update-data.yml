name: Process Parking Updates

on:
  # Run setiap 2 menit untuk real-time
  schedule:
    - cron: '*/2 * * * *'
  
  # Juga bisa di-trigger manual
  workflow_dispatch:
    inputs:
      force:
        description: 'Force process all pending updates'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  process-updates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Process updates from GitHub Issues
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
      run: |
        # Script untuk proses update
        cat > process-updates.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        
        console.log('ğŸš— Processing parking updates...');
        
        // File paths
        const dataPath = path.join(process.cwd(), 'data/parkir-data.json');
        const pendingPath = path.join(process.cwd(), 'data/pending-updates.json');
        
        // Load main data
        let mainData;
        try {
          mainData = JSON.parse(fs.readFileSync(dataPath, 'utf8'));
          console.log('âœ… Loaded main data');
        } catch (error) {
          console.error('âŒ Failed to load main data:', error);
          process.exit(1);
        }
        
        // Load pending updates
        let pendingUpdates = [];
        if (fs.existsSync(pendingPath)) {
          try {
            pendingUpdates = JSON.parse(fs.readFileSync(pendingPath, 'utf8'));
            console.log(`ğŸ“‹ Found ${pendingUpdates.length} pending updates`);
          } catch (error) {
            console.error('âŒ Failed to load pending updates:', error);
          }
        }
        
        // Process each pending update
        const processed = [];
        const failed = [];
        
        for (const update of pendingUpdates) {
          try {
            if (!update.location_id || !update.petugas_name) {
              throw new Error('Invalid update data');
            }
            
            // Find location
            const location = mainData.locations.find(l => l.id === update.location_id);
            if (!location) {
              throw new Error(`Location ${update.location_id} not found`);
            }
            
            // Update capacities
            if (update.bus !== undefined) {
              location.bus.available = parseInt(update.bus);
              location.bus.last_update = new Date().toISOString();
              location.bus.updated_by = update.petugas_name;
            }
            
            if (update.mobil !== undefined) {
              location.mobil.available = parseInt(update.mobil);
              location.mobil.last_update = new Date().toISOString();
              location.mobil.updated_by = update.petugas_name;
            }
            
            if (update.motor !== undefined) {
              location.motor.available = parseInt(update.motor);
              location.motor.last_update = new Date().toISOString();
              location.motor.updated_by = update.petugas_name;
            }
            
            if (update.notes) {
              location.notes = update.notes;
            }
            
            // Mark as processed
            update.processed_at = new Date().toISOString();
            update.status = 'processed';
            processed.push(update);
            
            console.log(`âœ… Updated ${location.nama}`);
            
          } catch (error) {
            console.error(`âŒ Failed to process update:`, error.message);
            update.error = error.message;
            update.status = 'failed';
            failed.push(update);
          }
        }
        
        // Update statistics
        const stats = mainData.locations.reduce((acc, loc) => {
          acc.bus += loc.bus.available || 0;
          acc.mobil += loc.mobil.available || 0;
          acc.motor += loc.motor.available || 0;
          return acc;
        }, { bus: 0, mobil: 0, motor: 0 });
        
        mainData.statistics.total_available_bus = stats.bus;
        mainData.statistics.total_available_mobil = stats.mobil;
        mainData.statistics.total_available_motor = stats.motor;
        mainData.statistics.update_count_today = (mainData.statistics.update_count_today || 0) + processed.length;
        mainData.statistics.last_processed = new Date().toISOString();
        
        mainData.metadata.last_updated = new Date().toISOString();
        mainData.metadata.updated_by = 'GitHub Actions';
        
        // Save updated data
        fs.writeFileSync(dataPath, JSON.stringify(mainData, null, 2));
        console.log('ğŸ’¾ Saved updated data');
        
        // Save failed updates back (retry later)
        fs.writeFileSync(pendingPath, JSON.stringify(failed, null, 2));
        
        // Create archive
        const archiveDir = path.join(process.cwd(), 'data/updates/archive');
        if (!fs.existsSync(archiveDir)) {
          fs.mkdirSync(archiveDir, { recursive: true });
        }
        
        const today = new Date().toISOString().split('T')[0];
        const archiveFile = path.join(archiveDir, `updates-${today}.json`);
        
        let archiveData = [];
        if (fs.existsSync(archiveFile)) {
          archiveData = JSON.parse(fs.readFileSync(archiveFile, 'utf8'));
        }
        
        archiveData.push(...processed);
        fs.writeFileSync(archiveFile, JSON.stringify(archiveData, null, 2));
        
        console.log('\nğŸ“Š SUMMARY:');
        console.log(`âœ… Processed: ${processed.length}`);
        console.log(`âŒ Failed: ${failed.length}`);
        console.log(`ğŸšŒ Bus available: ${stats.bus}`);
        console.log(`ğŸš— Mobil available: ${stats.mobil}`);
        console.log(`ğŸï¸ Motor available: ${stats.motor}`);
        
        EOF
        
        node process-updates.js
        
    - name: Commit and push changes
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions"
        
        git add .
        git commit -m "ğŸ”„ Auto-update parking data [$(date +'%H:%M')]" || echo "No changes to commit"
        git push
