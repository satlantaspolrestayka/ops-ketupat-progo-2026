name: Validate and Fix Parking Statistics

on:
  push:
    branches: [ main, master ]
    paths:
      - 'data/parkir-data.json'
      - '.github/workflows/validate-parking.yml'
  pull_request:
    paths:
      - 'data/parkir-data.json'
  schedule:
    # Run every hour during business hours (7 AM - 10 PM)
    - cron: '0 7-22 * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  validate-parking-data:
    name: Validate Parking Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Run Parking Data Validator
        id: validate
        run: |
          echo "ðŸ”„ Starting parking data validation..."
          
          # Load environment variables
          VALIDATION_MODE="${VALIDATION_MODE:-strict}"
          MAX_BACKUPS="${MAX_BACKUPS:-10}"
          NOTIFY_THRESHOLD="${NOTIFY_THRESHOLD:-90}"
          
          # Execute validation script
          node scripts/validate-parking.js \
            --mode="$VALIDATION_MODE" \
            --max-backups="$MAX_BACKUPS" \
            --threshold="$NOTIFY_THRESHOLD" \
            --log-level="info"
          
          # Capture exit code
          VALIDATION_EXIT_CODE=$?
          
          # Set output for next steps
          if [ $VALIDATION_EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parking-validation-report
          path: |
            data/validation-report-*.json
            data/logs/
            data/backups/
          retention-days: 30

      - name: Create Summary Report
        if: always()
        run: |
          echo "## Parking Data Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/validation-report-latest.json" ]; then
            echo "ðŸ“Š **Validation Completed Successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract and display summary
            SUMMARY=$(node -e "
              const report = require('./data/validation-report-latest.json');
              console.log('âœ… **Summary:**');
              console.log('- Total Locations: ' + report.summary.total_locations);
              console.log('- Total Capacity: ' + report.summary.total_capacity);
              console.log('- Available Spaces: ' + report.summary.total_available);
              console.log('- Utilization Rate: ' + report.summary.utilization_percent + '%');
              console.log('- Issues Fixed: ' + report.issues_fixed.length);
              console.log('- Validation Time: ' + new Date(report.timestamp).toLocaleString());
            ")
            
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Validation Failed**" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Send Notification on High Utilization
        if: steps.validate.outputs.success == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          node scripts/notify-utilization.js
